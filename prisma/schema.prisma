// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  COMPANY
  SEEKER
}

enum UserStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERNSHIP
}

enum JobStatus {
  PENDING
  ACTIVE
  CLOSED
  REJECTED
}

enum ApplicationStatus {
  PENDING
  OPENED        // เปิดอ่านแล้ว
  REVIEWING     // กำลังพิจารณา (เก็บไว้เพื่อข้อมูลเก่า)
  INTERVIEW_SCHEDULED  // นัดสัมภาษณ์
  ACCEPTED      // ผ่าน
  REJECTED      // ไม่ผ่าน
  WITHDRAWN
}

enum NotificationType {
  NEW_APPLICATION
  APPLICATION_STATUS_CHANGED
  JOB_APPROVED
  JOB_REJECTED
  COMPANY_APPROVED
  COMPANY_REJECTED
  NEW_JOB_MATCHING
}

model User {
  id          String      @id @default(cuid())
  email       String      @unique
  password    String
  role        UserRole
  name        String
  phone       String?
  status      UserStatus  @default(PENDING)
  lastLoginAt DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  company     Company?
  notifications Notification[]

  @@index([email])
  @@index([status])
}

model Company {
  id                 String   @id @default(cuid())
  userId             String   @unique
  name               String   // ชื่อบริษัท (ไทย)
  nameEn             String?  // ชื่อบริษัท (อังกฤษ)
  contactName        String?  // ชื่อผู้ติดต่อ
  contactPhone       String?  // เบอร์ผู้ติดต่อ

  description        String?
  about              String?  // เกี่ยวกับบริษัท (ใช้แทน editor แบบง่าย)

  // ที่อยู่บริษัท (แยกตามฟอร์ม)
  address            String?  // ที่อยู่รวม (คงไว้เพื่อ backward compatibility)
  addressLine        String?
  province           String?
  district           String?
  subdistrict        String?
  postalCode         String?

  // เอกสาร/แผนที่
  companyRegNo       String?  // เลขจดทะเบียนบริษัท
  companyRegDocUrl   String?  // URL ไฟล์เอกสารยืนยันเลขจดทะเบียน
  mapImageUrl        String?  // URL รูปแผนที่บริษัท (ถ้ามี)
  googleMapUrl       String?  // ลิงก์ Google Map

  // การเดินทาง
  btsLine            String?
  btsStation         String?
  mrtLine            String?
  mrtStation         String?
  srtLine            String?
  srtStation         String?
  arlStation         String?  // Airport Rail Link
  busLines           String?  // สายรถเมล์

  // สวัสดิการ / ธุรกิจ
  welfare            String?
  welfareOther       String?
  businessMain       String?
  businessSub        String?
  companySize        String?  // SMALL | MEDIUM | LARGE (เก็บเป็น string)

  // ข้อมูลติดต่อบริษัท/บัญชี/บิล
  phone              String?  // เบอร์โทรบริษัท
  phoneExt           String?  // ต่อ
  fax                String?
  billingName        String?  // ชื่อบิล
  billingAddress     String?  // ที่อยู่บิล
  billingEmail       String?  // อีเมลบัญชี
  taxId              String?  // เลขประจำตัวผู้เสียภาษี (ถ้ามี)

  website            String?
  logo               String?

  // ตั้งค่าการนำข้อมูลไปใช้กับตำแหน่งงาน
  applyProfileToAllJobs Boolean @default(false)

  creditsRemaining   Int      @default(0)
  currentPackageId   String?
  packageExpiresAt   DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobs              Job[]
  orders            Order[]
  savedApplications SavedApplication[]
  savedSeekers      SavedSeeker[]
  applicationViews  ApplicationView[]

  @@index([userId])
  @@index([province])
  @@index([district])
}

model Package {
  id             String   @id @default(cuid())
  name           String
  description    String?
  price          Decimal  @db.Decimal(10, 2)
  creditsIncluded Int     @default(0)
  features       String? // JSON or text
  isActive       Boolean  @default(true)
  sortOrder      Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  orders Order[]
}

model Order {
  id         String   @id @default(cuid())
  companyId  String
  packageId  String
  amount     Decimal  @db.Decimal(10, 2)
  status     String   @default("PENDING") // PENDING, PAID, FAILED, CANCELLED
  paidAt     DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  package Package @relation(fields: [packageId], references: [id], onDelete: Restrict)

  @@index([companyId])
  @@index([status])
}

model SavedApplication {
  id            String   @id @default(cuid())
  companyId     String
  applicationId String
  createdAt     DateTime @default(now())

  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@unique([companyId, applicationId])
  @@index([companyId])
}

model ApplicationView {
  id            String   @id @default(cuid())
  companyId     String
  applicationId String
  viewedAt      DateTime @default(now())

  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([applicationId])
  @@index([viewedAt])
}

model JobSeeker {
  id                 String   @id @default(cuid())
  lineUserId         String   @unique
  displayName        String
  pictureUrl         String?
  phone              String?
  email              String?
  age                Int?
  education          String?
  experience         String?
  skills             String?
  resumeUrl          String?
  isElderly          Boolean  @default(false)
  preferredArea      String?  // พื้นที่ที่สนใจ/อยู่ใกล้
  transitLineColors  String?  // JSON array: สาย BTS/MRT ที่เดินทางได้ เช่น ["RED","BLUE","PINK"]
  preferredJobTypes  String?  // JSON array: รูปแบบงานที่ต้องการ เช่น ["FULL_TIME","PART_TIME"]
  expectedSalaryMin  Int?    // เงินเดือนขั้นต่ำที่ต้องการ (บาท)
  expectedSalaryMax  Int?    // เงินเดือนสูงสุดที่ยอมรับได้ (บาท) - สำหรับเช็ค "คุ้มค่า"
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  applications Application[]
  notifications Notification[]
  savedBy      SavedSeeker[]

  @@index([lineUserId])
  @@index([isElderly])
  @@index([preferredArea])
  @@index([updatedAt])
}

model SavedSeeker {
  id         String   @id @default(cuid())
  companyId  String
  seekerId   String
  createdAt  DateTime @default(now())

  company Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  seeker  JobSeeker @relation(fields: [seekerId], references: [id], onDelete: Cascade)

  @@unique([companyId, seekerId])
  @@index([companyId])
  @@index([seekerId])
}

model Job {
  id                String      @id @default(cuid())
  companyId         String
  title             String
  description       String
  location          String
  salary            String?     // แสดงเป็นข้อความ เช่น "25,000 - 35,000 บาท"
  salaryMin         Int?        // สำหรับ match เงินเดือน (บาท)
  salaryMax         Int?        // สำหรับ match เงินเดือน (บาท)
  jobType           JobType
  requirements      String?
  forElderly        Boolean     @default(false)
  status            JobStatus   @default(PENDING)
  transitLineColors String?     // JSON array: สาย BTS/MRT ใกล้บริษัท เช่น ["RED","BLUE"]
  expiresAt         DateTime?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  applications Application[]

  @@index([companyId])
  @@index([status])
  @@index([createdAt])
  @@index([forElderly])
}

model Application {
  id                 String            @id @default(cuid())
  jobId              String
  seekerId           String
  coverLetter        String?
  status             ApplicationStatus  @default(PENDING)
  applicationChannel String?            @default("SELF_APPLIED") // SELF_APPLIED = ส่งใบสมัครเอง, HR_SAVED = HR กดบันทึก
  needsMoreInfo      Boolean            @default(false)
  additionalSkills   String?
  preferredLocations String?
  adminNotes         String?
  createdAt          DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  job               Job               @relation(fields: [jobId], references: [id], onDelete: Cascade)
  seeker            JobSeeker         @relation(fields: [seekerId], references: [id], onDelete: Cascade)
  savedBy           SavedApplication[]
  viewHistory       ApplicationView[]

  @@unique([jobId, seekerId])
  @@index([jobId])
  @@index([seekerId])
  @@index([status])
  @@index([needsMoreInfo])
  @@index([createdAt])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String?
  seekerId  String?
  title     String
  message   String
  type      NotificationType
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  user      User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  seeker    JobSeeker?       @relation(fields: [seekerId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([seekerId, isRead])
  @@index([createdAt])
}
